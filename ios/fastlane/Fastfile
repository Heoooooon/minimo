default_platform(:ios)

platform :ios do
  desc "TestFlight에 업로드"
  lane :beta do
    # API Key 설정
    api_key = app_store_connect_api_key(
      key_id: "BZANF747DT",
      issuer_id: "9c4466a3-46f7-4e76-97e9-d5eb1d202d15",
      key_filepath: "fastlane/AuthKey_BZANF747DT.p8"
    )

    # Flutter 빌드
    sh "cd ../.. && flutter build ipa --release"

    # TestFlight 업로드
    upload_to_testflight(
      api_key: api_key,
      ipa: "../build/ios/ipa/oomool.ipa",
      skip_waiting_for_build_processing: true
    )
  end

  desc "App Store에 제출 (메타데이터 포함)"
  lane :release do
    # API Key 설정
    api_key = app_store_connect_api_key(
      key_id: "BZANF747DT",
      issuer_id: "9c4466a3-46f7-4e76-97e9-d5eb1d202d15",
      key_filepath: "fastlane/AuthKey_BZANF747DT.p8"
    )

    # Flutter 빌드
    sh "cd ../.. && flutter build ipa --release"

    # App Store 업로드 (메타데이터 포함)
    upload_to_app_store(
      api_key: api_key,
      ipa: "../build/ios/ipa/oomool.ipa",
      skip_screenshots: true,
      skip_metadata: false,
      force: true
    )
  end

  desc "메타데이터만 업로드 (빌드 없이)"
  lane :metadata do
    api_key = app_store_connect_api_key(
      key_id: "BZANF747DT",
      issuer_id: "9c4466a3-46f7-4e76-97e9-d5eb1d202d15",
      key_filepath: "fastlane/AuthKey_BZANF747DT.p8"
    )

    upload_to_app_store(
      api_key: api_key,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true
    )
  end

  desc "빌드 번호 증가 후 TestFlight 업로드"
  lane :deploy do
    # 빌드 번호 증가
    increment_build_number_flutter

    # TestFlight 업로드
    beta
  end
end

# Flutter 빌드 번호 증가 헬퍼
def increment_build_number_flutter
  pubspec_path = "../../pubspec.yaml"
  pubspec = File.read(pubspec_path)

  # 현재 버전 파싱 (예: 1.0.0+2)
  current_version = pubspec.match(/version:\s*(\d+\.\d+\.\d+)\+(\d+)/i)
  if current_version
    version = current_version[1]
    build = current_version[2].to_i + 1
    new_version = "version: #{version}+#{build}"

    pubspec.gsub!(/version:\s*\d+\.\d+\.\d+\+\d+/i, new_version)
    File.write(pubspec_path, pubspec)

    UI.success("빌드 번호 증가: #{version}+#{build}")
  end
end
